name: PHP-MCP Server Update Notifications

on:
  pull_request:
    types: [opened]
    paths:
      - 'composer.json'
      - 'composer.lock'

jobs:
  notify-php-mcp-updates:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
        
      - name: Check for php-mcp/server updates
        id: check-update
        run: |
          # Check if this PR contains php-mcp/server updates
          if git diff HEAD~1 HEAD -- composer.json composer.lock | grep -q "php-mcp/server"; then
            echo "php_mcp_updated=true" >> $GITHUB_OUTPUT
            
            # Extract version information
            OLD_VERSION=$(git show HEAD~1:composer.json | grep -o '"php-mcp/server": "[^"]*"' | cut -d'"' -f4 || echo "unknown")
            NEW_VERSION=$(git show HEAD:composer.json | grep -o '"php-mcp/server": "[^"]*"' | cut -d'"' -f4 || echo "unknown")
            
            echo "old_version=${OLD_VERSION}" >> $GITHUB_OUTPUT
            echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          else
            echo "php_mcp_updated=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Create Issue for php-mcp/server Update
        if: steps.check-update.outputs.php_mcp_updated == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const oldVersion = '${{ steps.check-update.outputs.old_version }}';
            const newVersion = '${{ steps.check-update.outputs.new_version }}';
            
            const title = `ðŸš€ php-mcp/server ì—…ë°ì´íŠ¸: ${oldVersion} â†’ ${newVersion}`;
            const body = `
            ## php-mcp/server ìƒˆ ë²„ì „ ì—…ë°ì´íŠ¸ ì•Œë¦¼
            
            \`php-mcp/server\` íŒ¨í‚¤ì§€ê°€ ìƒˆ ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.
            
            ### ë²„ì „ ì •ë³´
            - **ì´ì „ ë²„ì „**: \`${oldVersion}\`
            - **ìƒˆ ë²„ì „**: \`${newVersion}\`
            
            ### ê´€ë ¨ Pull Request
            - PR: #${{ github.event.number }}
            - ì œëª©: ${{ github.event.pull_request.title }}
            - ë§í¬: ${{ github.event.pull_request.html_url }}
            
            ### í™•ì¸ ì‚¬í•­
            - [ ] [ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸](https://github.com/php-mcp/server/releases) ê²€í† 
            - [ ] Breaking Changes í™•ì¸
            - [ ] MCP Server ëª¨ë“ˆê³¼ì˜ í˜¸í™˜ì„± í…ŒìŠ¤íŠ¸
            - [ ] ê¸°ì¡´ MCP íˆ´ë“¤ì˜ ìž‘ë™ í™•ì¸
            - [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸ í•„ìš”ì„± ê²€í† 
            - [ ] ì˜ˆì œ ì½”ë“œ ì—…ë°ì´íŠ¸ í•„ìš”ì„± í™•ì¸
            
            ### í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸
            - [ ] MCP ì„œë²„ ì‹œìž‘/ì •ì§€ í…ŒìŠ¤íŠ¸
            - [ ] ê¸°ì¡´ MCP íˆ´ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
            - [ ] ìƒˆë¡œìš´ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ (í•´ë‹¹í•˜ëŠ” ê²½ìš°)
            - [ ] ì—ëŸ¬ í•¸ë“¤ë§ í…ŒìŠ¤íŠ¸
            
            ### ì°¸ê³  ë§í¬
            - [php-mcp/server GitHub](https://github.com/php-mcp/server)
            - [php-mcp/server ë¦´ë¦¬ì¦ˆ](https://github.com/php-mcp/server/releases)
            - [MCP í”„ë¡œí† ì½œ ë¬¸ì„œ](https://modelcontextprotocol.io/)
            
            ---
            _ì´ ì´ìŠˆëŠ” Dependabotì˜ \`php-mcp/server\` ì—…ë°ì´íŠ¸ ê°ì§€ ì‹œ ìžë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤._
            `;
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['dependencies', 'php-mcp-server', 'update-notification', 'auto-generated']
            });
            
            console.log('Created issue:', issue.data.html_url);
            
      - name: Add comment to PR
        if: steps.check-update.outputs.php_mcp_updated == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const oldVersion = '${{ steps.check-update.outputs.old_version }}';
            const newVersion = '${{ steps.check-update.outputs.new_version }}';
            
            const comment = `ðŸ”” **php-mcp/server ì—…ë°ì´íŠ¸ ê°ì§€!**
            
            \`${oldVersion}\` â†’ \`${newVersion}\`
            
            ê´€ë ¨ ì´ìŠˆê°€ ìžë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì—…ë°ì´íŠ¸ ì „ì— ë‹¤ìŒ ì‚¬í•­ì„ í™•ì¸í•´ ì£¼ì„¸ìš”:
            
            1. ðŸ“– [ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸](https://github.com/php-mcp/server/releases) ê²€í† 
            2. âš ï¸ Breaking Changes í™•ì¸
            3. ðŸ§ª í˜¸í™˜ì„± í…ŒìŠ¤íŠ¸ ìˆ˜í–‰
            4. ðŸ“š ë¬¸ì„œ ì—…ë°ì´íŠ¸ ê²€í† 
            
            **ì¤‘ìš”**: í”„ë¡œë•ì…˜ ë°°í¬ ì „ì— ì¶©ë¶„í•œ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”.`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
      - name: Add release info comment
        if: steps.check-update.outputs.php_mcp_updated == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const newVersion = '${{ steps.check-update.outputs.new_version }}';
            
            try {
              // Try to fetch release information from php-mcp/server
              const response = await fetch('https://api.github.com/repos/php-mcp/server/releases');
              const releases = await response.json();
              
              // Find the latest release that matches the new version
              const matchingRelease = releases.find(release => 
                release.tag_name === newVersion || release.tag_name === 'v' + newVersion
              );
              
              if (matchingRelease) {
                const releaseComment = `ðŸ“‹ **ë¦´ë¦¬ì¦ˆ ì •ë³´**
                
                **${matchingRelease.name || matchingRelease.tag_name}**
                
                ${matchingRelease.body || 'ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.'}
                
                ðŸ”— [ì „ì²´ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ë³´ê¸°](${matchingRelease.html_url})`;
                
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: releaseComment
                });
              }
            } catch (error) {
              console.log('Could not fetch release info:', error.message);
            }